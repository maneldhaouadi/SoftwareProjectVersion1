{% extends 'base.html' %}
{% block content %}
<div class="container mt-4">
  <h2>Mes tâches (Médecin)</h2>
  <p>Bonjour {{ employee.nom }} {{ employee.prenom }} ({{ employee.service }})</p>

  <div class="mb-3">
    <a href="{% url 'employee:doctor_create_tache' %}" class="btn btn-success">Ajouter une nouvelle tâche</a>
    <a href="{% url 'employee:notification_preferences' %}" class="btn btn-outline-secondary ms-2">Préférences notifications</a>
  </div>

  {% if shared_taches %}
  <h4 class="mt-4">Tâches partagées avec moi</h4>
  <div class="table-responsive">
    <table class="table table-striped table-bordered">
      <thead>
        <tr>
          <th>Owner</th>
          <th>Description</th>
          <th>Date échéance</th>
          <th>Statut</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for t in shared_taches %}
        <tr
          {% if t.statut == 'Done' %} class="table-success" style="border-left: 6px solid #198754;"
          {% elif t.date_echeance < today %} class="table-danger" style="border-left: 6px solid #dc3545;"
          {% elif t.statut == 'Pending' %} class="table-warning" style="border-left: 6px solid #ffc107;"
          {% endif %}>
          <td>{{ t.employee.nom }} {{ t.employee.prenom }}</td>
          <td>
            {{ t.description }}
            {% if t.collaborators.count %}
              <span class="ms-2">
              {% for c in t.collaborators.all %}
                <span class="badge bg-secondary me-1">{{ c.nom }} {{ c.prenom }} ({{ c.role }})</span>
              {% endfor %}
              </span>
            {% endif %}
          </td>
          <td>{{ t.date_echeance }}</td>
          <td>{{ t.get_statut_display }}</td>
          <td>
            <form method="post" action="{% url 'employee:update_task_status' t.pk %}" style="display:inline-block">
              {% csrf_token %}
              {% if t.statut == 'Pending' %}
                <input type="hidden" name="statut" value="Done">
                <button class="btn btn-sm btn-success">Marquer Terminée</button>
              {% else %}
                <input type="hidden" name="statut" value="Pending">
                <button class="btn btn-sm btn-warning">Remettre en attente</button>
              {% endif %}
            </form>
            <a class="btn btn-sm btn-info ms-1" href="{% url 'employee:edit_task_notification' t.pk %}?next={{ request.get_full_path|urlencode }}">Notifications</a>
            <a class="btn btn-sm btn-outline-secondary ms-1" href="{% url 'employee:task_detail' t.pk %}">Détails</a>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="5">Aucune tâche partagée</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% endif %}

  {% if upcoming_taches %}
  <div class="alert alert-warning">
    <h5>Notifications</h5>
    <p>Vous avez {{ upcoming_taches|length }} tâche(s) à réaliser dans votre intervalle de notification :</p>
    <ul>
      {% for ut in upcoming_taches %}
  <li{% if ut.date_echeance < today %} style="color: #dc3545;"{% endif %}>[{{ ut.notify_interval_hours }}h] {{ ut.description }} — échéance {{ ut.date_echeance }}</li>
      {% endfor %}
    </ul>
  </div>
  {% endif %}

  <form method="get" class="row g-2 align-items-end mb-3">
    <div class="col-auto">
      <label class="form-label">Statut</label>
      <select name="statut" class="form-select">
        <option value="">Tous</option>
        <option value="Pending" {% if filter_statut == 'Pending' %}selected{% endif %}>En attente</option>
        <option value="Done" {% if filter_statut == 'Done' %}selected{% endif %}>Terminée</option>
      </select>
    </div>
    <div class="col-auto">
      <label class="form-label">Date depuis</label>
      <input type="date" name="date_from" class="form-control" value="{{ filter_date_from }}">
    </div>
    <div class="col-auto">
      <label class="form-label">Date jusqu'à</label>
      <input type="date" name="date_to" class="form-control" value="{{ filter_date_to }}">
    </div>
    <div class="col-auto">
      <button class="btn btn-primary">Filtrer</button>
      <a href="{% url 'employee:doctor_list_taches' %}" class="btn btn-secondary ms-2">Réinitialiser</a>
    </div>
  </form>

  <div class="table-responsive">
    <table class="table table-striped table-bordered" id="tache-table">
      <thead>
        <tr>
          <th>#</th>
          <th>Description</th>
          <th>Date échéance</th>
          <th>Statut</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for t in taches %}
    <tr draggable="true" data-id="{{ t.idTache }}"
      {% if t.statut == 'Done' %} class="table-success" style="border-left: 6px solid #198754;"
      {% elif t.date_echeance < today %} class="table-danger" style="border-left: 6px solid #dc3545;"
      {% elif t.statut == 'Pending' %} class="table-warning" style="border-left: 6px solid #ffc107;"
      {% endif %}>
          <td>{{ t.order }}</td>
          <td>
            {{ t.description }}
            {% if t.collaborators.count %}
              <span class="ms-2">
              {% for c in t.collaborators.all %}
                <span class="badge bg-secondary me-1">{{ c.nom }} {{ c.prenom }} ({{ c.role }})</span>
              {% endfor %}
              </span>
            {% endif %}
          </td>
          <td>{{ t.date_echeance }}</td>
          <td>{{ t.get_statut_display }}</td>
          <td>
            <a class="btn btn-sm btn-primary" href="{% url 'employee:doctor_edit_tache' t.pk %}">Modifier</a>
            <a class="btn btn-sm btn-info" href="{% url 'employee:edit_task_notification' t.pk %}?next={{ request.get_full_path|urlencode }}">Notifications</a>
            <a class="btn btn-sm btn-outline-dark" href="{% url 'employee:edit_task_collaborators' t.pk %}?next={{ request.get_full_path|urlencode }}">Collaborateurs</a>
            <a class="btn btn-sm btn-outline-secondary" href="{% url 'employee:task_detail' t.pk %}">Détails</a>
            <form method="post" action="{% url 'employee:doctor_delete_tache' t.pk %}" style="display:inline-block">
              {% csrf_token %}
              <button class="btn btn-sm btn-danger" onclick="return confirm('Supprimer cette tâche ?')">Supprimer</button>
            </form>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="5">Aucune tâche trouvée</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <script>
  // Basic HTML5 drag and drop to reorder rows
  const tbody = document.querySelector('#tache-table tbody');
  let dragSrcRow = null;
  let dragging = false;

  function handleDragStart(e) { dragSrcRow = this; this.style.opacity = '0.4'; dragging = true; }
  function handleDragOver(e) {
    e.preventDefault();
    if (!dragging || !dragSrcRow) return false;
    const target = this;
    if (target === dragSrcRow) return false;
    const rect = target.getBoundingClientRect();
    const midpoint = rect.top + rect.height / 2;
    const before = e.clientY < midpoint;
    if (before) {
      tbody.insertBefore(dragSrcRow, target);
    } else {
      tbody.insertBefore(dragSrcRow, target.nextSibling);
    }
    return false;
  }
  function handleDragEnter(e) { this.classList.add('table-active'); }
  function handleDragLeave(e) { this.classList.remove('table-active'); }
  function handleDrop(e) {
    e.stopPropagation();
    updateOrderOnServer();
    return false;
  }
  function handleDragEnd(e) { this.style.opacity = '1'; dragging = false; tbody.querySelectorAll('tr').forEach(r => r.classList.remove('table-active')); }

  function wireRows() {
    tbody.querySelectorAll('tr[draggable="true"]').forEach(row => {
      row.addEventListener('dragstart', handleDragStart, false);
      row.addEventListener('dragenter', handleDragEnter, false);
      row.addEventListener('dragover', handleDragOver, false);
      row.addEventListener('dragleave', handleDragLeave, false);
      row.addEventListener('drop', handleDrop, false);
      row.addEventListener('dragend', handleDragEnd, false);
    });
  }

  async function updateOrderOnServer() {
    const ids = Array.from(tbody.querySelectorAll('tr[draggable="true"]')).map(r => parseInt(r.dataset.id));
    try {
      const resp = await fetch('{% url "employee:reorder_tasks" %}', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCSRFToken() },
        body: JSON.stringify({ order: ids })
      });
      if (resp.ok) {
        // Update first column order numbers
        tbody.querySelectorAll('tr').forEach((r, idx) => {
          const firstCell = r.querySelector('td');
          if (firstCell) firstCell.textContent = (idx + 1).toString();
        });
      }
    } catch (e) { console.error(e); }
  }

  function getCSRFToken() {
    const name = 'csrftoken';
    const cookies = document.cookie.split(';');
    for (let c of cookies) {
      const k = c.trim();
      if (k.startsWith(name + '=')) return decodeURIComponent(k.split('=')[1]);
    }
    return '';
  }

  wireRows();
  </script>
</div>
{% endblock %}
